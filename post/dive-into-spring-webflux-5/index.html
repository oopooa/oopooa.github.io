<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="自定义数据流，背压机制，响应式编程原理深入"><title>响应式编程 Spring Webflux 详解（五）</title>
<link rel=canonical href=https://opoa.top/post/dive-into-spring-webflux-5/><link rel=stylesheet href=/scss/style.min.f576b0c5733141aff22765f36bccdcea4246e1f096129d682fc48cb418451a41.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta property='og:title' content="响应式编程 Spring Webflux 详解（五）"><meta property='og:description' content="自定义数据流，背压机制，响应式编程原理深入"><meta property='og:url' content='https://opoa.top/post/dive-into-spring-webflux-5/'><meta property='og:site_name' content='Opoa'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring'><meta property='article:tag' content='Java'><meta property='article:tag' content='Spring Webflux'><meta property='article:published_time' content='2022-10-02T23:13:17+08:00'><meta property='article:modified_time' content='2022-10-02T23:13:17+08:00'><meta property='og:image' content='https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/kimi-no-na-wa.webp'><meta name=twitter:title content="响应式编程 Spring Webflux 详解（五）"><meta name=twitter:description content="自定义数据流，背压机制，响应式编程原理深入"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/kimi-no-na-wa.webp'><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-5TC51Z6DWN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5TC51Z6DWN")}</script><link rel=stylesheet href=https://npm.elemecdn.com/@highlightjs/cdn-assets@11.7.0/styles/atom-one-dark.min.css><script src=https://npm.elemecdn.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>document.addEventListener("DOMContentLoaded",e=>{document.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e)})})</script><style>:root{--sys-font-family:"HarmonyOS_Sans_SC_Medium", Georgia, -apple-system, 'Nimbus Roman No9 L', 'PingFang SC', 'Hiragino Sans GB', 'Noto Serif SC', 'Microsoft Yahei', 'WenQuanYi Micro Hei', 'ST Heiti', sans-serif;--code-font-family:"JetBrainsMono Regular", Menlo, Monaco, Consolas, "Courier New";--article-font-family:"HarmonyOS_Sans_SC_Medium", var(--base-font-family)}</style><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huc9522c74db490d479204dfcc8d873015_49072_300x0_resize_q75_h2_box_2.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Opoa</a></h1><h2 class=site-description>Nut 🤪</h2></div></header><ol class=menu-social><li><a href=https://github.com/oopooa target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://space.bilibili.com/19315530 target=_blank title=Bilibili rel=me><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a></li><li><a href=https://www.youtube.com/@opoa9880 target=_blank title=Youtube rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-youtube" width="64" height="64" viewBox="0 0 24 24" stroke-width="1.5" stroke="#000" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M2 8a4 4 0 014-4h12a4 4 0 014 4v8a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><path d="M10 9l5 3-5 3z"/></svg></a></li><li><a href=https://opoa.top/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页 | Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档 | Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索 | Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#自定义数据流>自定义数据流</a><ol><li><a href=#flux-create>Flux Create</a></li><li><a href=#flux-generate>Flux Generate</a><ol><li><a href=#create>Create</a></li><li><a href=#generate>Generate</a></li></ol></li></ol></li><li><a href=#背压机制>背压机制</a><ol><li><a href=#什么是背压>什么是背压</a></li><li><a href=#背压预防系统故障>背压预防系统故障</a></li><li><a href=#背压控制>背压控制</a></li><li><a href=#背压机制的实现>背压机制的实现</a><ol><li><a href=#request>Request</a></li><li><a href=#limit>Limit</a></li><li><a href=#cancel>Cancel</a></li></ol></li></ol></li><li><a href=#深入理解响应式流>深入理解响应式流</a><ol><li><a href=#响应式流规范>响应式流规范</a></li><li><a href=#响应式流接口>响应式流接口</a></li><li><a href=#订阅之后发生了什么>订阅之后发生了什么</a></li><li><a href=#操作符-流水线>操作符 &ldquo;流水线&rdquo;</a></li><li><a href=#lambdasubscriber>LambdaSubscriber</a></li></ol></li><li><a href=#heading>🕳🕳🕳</a><ol><li><a href=#switchifempty-总是执行>SwitchIfEmpty 总是执行</a><ol><li><a href=#示例>示例</a></li><li><a href=#为什么>为什么</a></li><li><a href=#解决办法>解决办法</a></li></ol></li></ol></li><li><a href=#参考资料>参考资料</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/dive-into-spring-webflux-5/><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/kimi-no-na-wa.webp loading=lazy alt="Featured image of post 响应式编程 Spring Webflux 详解（五）"></a></div><div class=article-details><header class=article-category><a href=/categories/tech/ style=background-color:#598dfa;color:#fff>技术</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/dive-into-spring-webflux-5/>响应式编程 Spring Webflux 详解（五）</a></h2><h3 class=article-subtitle>自定义数据流，背压机制，响应式编程原理深入</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022-10-02</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 16 分钟</time></div></footer></div></header><section class=article-content><h2 id=自定义数据流>自定义数据流</h2><p>我们可以通过定义相应的事件（<code>onNext</code>、<code>onError</code> 和 <code>onComplete</code>）创建一个 <code>Flux</code> 或 <code>Mono</code>。Reactort 提供了 <code>generate</code>、<code>create</code>、<code>push</code> 和 <code>handle</code> 等方法，所有这些方法都使用 sink（池）来生成数据流。</p><p>sink，顾名思义，就是池子，可以想象一下厨房水池的样子。如图所示：</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/data-flow.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/data-flow.webp alt=data-flow></a></div></p><p>sink 通常至少会暴露三个方法给我们，<code>next</code>、<code>error</code> 和 <code>complete</code>。next 和 error 相当于两个下水口，我们不断将自定义的数据放到 next 口，Reactor 就会帮我们串成一个 publisher 数据流，直到有一个错误数据放到 error 口，或者按了一下 <code>compelete</code> 按钮，数据流就会终止了。</p><h3 id=flux-create>Flux Create</h3><p><code>create</code> 方法接受一个 <code>FluxSink&lt;T></code> 消费者，也就是说，你需要提供一个 <code>FluxSink</code> 的实例用来给下游的订阅者们发送 0 到 N 个元素。每个订阅者都会获得一个 <code>FluxSink</code> 的实例发送元素。</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/flux-create.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/flux-create.webp alt=flux-create></a></div></p><p>这个例子用 <code>Flux.create</code> 创建了一个序列。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integerFlux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>create</span><span class=p>((</span><span class=n>FluxSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>fluxSink</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IntStream</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>peek</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;going to emit - &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>fluxSink</span><span class=p>::</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></div><p>我们有两个下游的订阅者</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//First observer. takes 1 ms to process each element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>integerFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>1</span><span class=p>)).</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;First: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//Second observer. takes 2 ms to process each element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>integerFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>2</span><span class=p>)).</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Second: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>going to emit - 0
</span></span><span class=line><span class=cl>going to emit - 1
</span></span><span class=line><span class=cl>going to emit - 2
</span></span><span class=line><span class=cl>going to emit - 3
</span></span><span class=line><span class=cl>going to emit - 4
</span></span><span class=line><span class=cl>going to emit - 0
</span></span><span class=line><span class=cl>going to emit - 1
</span></span><span class=line><span class=cl>going to emit - 2
</span></span><span class=line><span class=cl>going to emit - 3
</span></span><span class=line><span class=cl>going to emit - 4
</span></span><span class=line><span class=cl>First: 0
</span></span><span class=line><span class=cl>Second: 0
</span></span><span class=line><span class=cl>First: 1
</span></span><span class=line><span class=cl>Second: 1
</span></span><span class=line><span class=cl>First: 2
</span></span><span class=line><span class=cl>Second: 2
</span></span><span class=line><span class=cl>First: 3
</span></span><span class=line><span class=cl>Second: 3
</span></span><span class=line><span class=cl>Second: 4
</span></span><span class=line><span class=cl>First: 4
</span></span></code></pre></div><p>通过输出我们可以发现</p><ul><li>每个订阅者都有自己的 <code>FluxSink</code> 实例，正如我们期望的创建了一个冷的发布者。</li><li><code>create</code> 不会等待订阅者处理元素，它甚至可能在订阅者开始处理前就发送元素。</li></ul><p>如果订阅者的处理速度跟不上怎么办？<code>create</code> 能够额外接受一个定义数据溢出时处理策略的参数，默认的策略是 <code>buffer</code>。</p><p>具体能选择的策略有：</p><ul><li>BUFFER：缓存下游没来得及处理的元素（如果缓存不限大小可能导致 OOM）。</li><li>DROP：当下游没有准备好接收新的元素时丢弃这个元素。</li><li>ERROR：当下游来不及处理时抛出 <code>IllegalStateException</code>。</li><li>IGNORE：完全忽略下游的背压请求。</li><li>LATEST：下游只会获得上游最新的元素。</li></ul><p>如果需要的话，我们也可以在 <code>create</code> 方法之外获取 <code>FluxSink</code> 实例的引用并且发送元素，它不是必须要发生在 <code>create</code> 方法内。</p><p>一个简易的 FluxSink 消费者实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FluxSinkImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;</span><span class=n>FluxSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>FluxSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>fluxSink</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>accept</span><span class=p>(</span><span class=n>FluxSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integerFluxSink</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>fluxSink</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>integerFluxSink</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>publishEvent</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>fluxSink</span><span class=p>.</span><span class=na>next</span><span class=p>(</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>发送元素：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建一个 FluxSink 实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FluxSinkImpl</span><span class=w> </span><span class=n>fluxSinkConsumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FluxSinkImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//create 方法能够传入这个实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integerFlux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>fluxSinkConsumer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>1</span><span class=p>)).</span><span class=na>share</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>integerFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>1</span><span class=p>)).</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;First: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>integerFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>2</span><span class=p>)).</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Second: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 在这里发送元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>IntStream</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>fluxSinkConsumer</span><span class=p>::</span><span class=n>publishEvent</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Second: 0
</span></span><span class=line><span class=cl>First: 0
</span></span><span class=line><span class=cl>Second: 1
</span></span><span class=line><span class=cl>First: 1
</span></span><span class=line><span class=cl>First: 2
</span></span><span class=line><span class=cl>Second: 2
</span></span><span class=line><span class=cl>First: 3
</span></span><span class=line><span class=cl>Second: 3
</span></span><span class=line><span class=cl>First: 4
</span></span><span class=line><span class=cl>Second: 4
</span></span></code></pre></div><h3 id=flux-generate>Flux Generate</h3><p><code>generate</code> 与 <code>create</code> 稍微有些不同，它接收一个 <code>SynchronousSink&lt;T></code> 的消费者，在上面的 <code>create</code> 方法，我们可以通过消费者发送 0 到 N 个元素，但是在 <code>generate</code> 方法，我们只能发送一个元素。</p><p>是否意味着这个 <code>flux</code> 最多只能发送一个元素？</p><p>并不是，<code>generate</code> 方法也能发送 <strong>无限数量的元素</strong>。<code>generate</code> 方法能够基于下游的请求一个接一个地发送元素。消费者自己不能循环地发送元素，如果订阅者对后续的元素不敢兴趣，那么 <code>generate</code> 也不会发送元素。</p><p>为了更好地便于理解它们的行为，试着运行以下代码。</p><h4 id=create>Create</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integerFlux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>create</span><span class=p>((</span><span class=n>FluxSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>fluxSink</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Flux create&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IntStream</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>peek</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;going to emit - &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>fluxSink</span><span class=p>::</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>integerFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>50</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;First consumed: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Flux create
</span></span><span class=line><span class=cl>going to emit - 0
</span></span><span class=line><span class=cl>going to emit - 1
</span></span><span class=line><span class=cl>going to emit - 2
</span></span><span class=line><span class=cl>going to emit - 3
</span></span><span class=line><span class=cl>going to emit - 4
</span></span><span class=line><span class=cl>going to emit - 5
</span></span><span class=line><span class=cl>going to emit - 6
</span></span><span class=line><span class=cl>going to emit - 7
</span></span><span class=line><span class=cl>going to emit - 8
</span></span><span class=line><span class=cl>going to emit - 9
</span></span><span class=line><span class=cl>going to emit - 10
</span></span><span class=line><span class=cl>going to emit - 11
</span></span><span class=line><span class=cl>going to emit - 12
</span></span><span class=line><span class=cl>........
</span></span><span class=line><span class=cl>going to emit - 91
</span></span><span class=line><span class=cl>going to emit - 92
</span></span><span class=line><span class=cl>going to emit - 93
</span></span><span class=line><span class=cl>going to emit - 94
</span></span><span class=line><span class=cl>going to emit - 95
</span></span><span class=line><span class=cl>going to emit - 96
</span></span><span class=line><span class=cl>going to emit - 97
</span></span><span class=line><span class=cl>going to emit - 98
</span></span><span class=line><span class=cl>going to emit - 99
</span></span><span class=line><span class=cl>First consumed: 0
</span></span><span class=line><span class=cl>First consumed: 1
</span></span><span class=line><span class=cl>First consumed: 2
</span></span><span class=line><span class=cl>First consumed: 3
</span></span><span class=line><span class=cl>First consumed: 4
</span></span><span class=line><span class=cl>First consumed: 5
</span></span><span class=line><span class=cl>First consumed: 6
</span></span><span class=line><span class=cl>First consumed: 7
</span></span><span class=line><span class=cl>First consumed: 8
</span></span><span class=line><span class=cl>First consumed: 9
</span></span><span class=line><span class=cl>First consumed: 10
</span></span><span class=line><span class=cl>........
</span></span><span class=line><span class=cl>First consumed: 94
</span></span><span class=line><span class=cl>First consumed: 95
</span></span><span class=line><span class=cl>First consumed: 96
</span></span><span class=line><span class=cl>First consumed: 97
</span></span><span class=line><span class=cl>First consumed: 98
</span></span><span class=line><span class=cl>First consumed: 99
</span></span></code></pre></div><ul><li>在上面的消费者 <code>FluxSink&lt;Integer></code>，它有一个循环持续地发送元素。</li><li>&ldquo;Flux create&rdquo; 只执行了一次。</li><li>&ldquo;going to emit&rdquo; 语句执行了 100 次。</li><li>然后所有的 &ldquo;First consumed&rdquo; 一个接一个地执行。</li></ul><h4 id=generate>Generate</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AtomicInteger</span><span class=w> </span><span class=n>atomicInteger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Flux generate sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integerFlux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>generate</span><span class=p>((</span><span class=n>SynchronousSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>synchronousSink</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Flux generate&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>synchronousSink</span><span class=p>.</span><span class=na>next</span><span class=p>(</span><span class=n>atomicInteger</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>integerFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>100</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;First consumed: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><br><details><summary>输出</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>First consumed: 0
</span></span><span class=line><span class=cl>First consumed: 1
</span></span><span class=line><span class=cl>First consumed: 2
</span></span><span class=line><span class=cl>First consumed: 3
</span></span><span class=line><span class=cl>First consumed: 4
</span></span><span class=line><span class=cl>First consumed: 5
</span></span><span class=line><span class=cl>First consumed: 6
</span></span><span class=line><span class=cl>First consumed: 7
</span></span><span class=line><span class=cl>First consumed: 8
</span></span><span class=line><span class=cl>First consumed: 9
</span></span><span class=line><span class=cl>First consumed: 10
</span></span><span class=line><span class=cl>First consumed: 11
</span></span><span class=line><span class=cl>First consumed: 12
</span></span><span class=line><span class=cl>First consumed: 13
</span></span><span class=line><span class=cl>First consumed: 14
</span></span><span class=line><span class=cl>First consumed: 15
</span></span><span class=line><span class=cl>First consumed: 16
</span></span><span class=line><span class=cl>First consumed: 17
</span></span><span class=line><span class=cl>First consumed: 18
</span></span><span class=line><span class=cl>First consumed: 19
</span></span><span class=line><span class=cl>First consumed: 20
</span></span><span class=line><span class=cl>First consumed: 21
</span></span><span class=line><span class=cl>First consumed: 22
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>First consumed: 23
</span></span><span class=line><span class=cl>First consumed: 24
</span></span><span class=line><span class=cl>First consumed: 25
</span></span><span class=line><span class=cl>First consumed: 26
</span></span><span class=line><span class=cl>First consumed: 27
</span></span><span class=line><span class=cl>First consumed: 28
</span></span><span class=line><span class=cl>First consumed: 29
</span></span><span class=line><span class=cl>First consumed: 30
</span></span><span class=line><span class=cl>First consumed: 31
</span></span><span class=line><span class=cl>First consumed: 32
</span></span><span class=line><span class=cl>First consumed: 33
</span></span><span class=line><span class=cl>First consumed: 34
</span></span><span class=line><span class=cl>First consumed: 35
</span></span><span class=line><span class=cl>First consumed: 36
</span></span><span class=line><span class=cl>First consumed: 37
</span></span><span class=line><span class=cl>First consumed: 38
</span></span><span class=line><span class=cl>First consumed: 39
</span></span><span class=line><span class=cl>First consumed: 40
</span></span><span class=line><span class=cl>First consumed: 41
</span></span><span class=line><span class=cl>First consumed: 42
</span></span><span class=line><span class=cl>First consumed: 43
</span></span><span class=line><span class=cl>First consumed: 44
</span></span><span class=line><span class=cl>First consumed: 45
</span></span><span class=line><span class=cl>First consumed: 46
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>.........
</span></span></code></pre></div></details><ul><li>&ldquo;Flux generate&rdquo; 执行了 32 次。</li><li>&ldquo;First consumed&rdquo; 执行了 23 次。</li><li>又是一堆 &ldquo;Flux generate&rdquo;。</li><li>然后又是一堆 &ldquo;First consumed&rdquo;。</li></ul><p><code>generate</code> 方法是基于下游的请求发送元素，它首先生成了 32 个元素并且缓存，当下游开始处理元素并且缓冲区的容量小于阈值时，它会再发一些元素。这个过程会一直重复，但有一点要注意，如果订阅者停止处理元素，<code>Flux.generate</code> 也会停止发送元素。所以 <code>generate</code> 方法能知道下游订阅者的处理速度。</p><p>我们试一下同时发送两个元素</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AtomicInteger</span><span class=w> </span><span class=n>atomicInteger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>integerFlux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>generate</span><span class=p>((</span><span class=n>SynchronousSink</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>synchronousSink</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Flux generate&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>synchronousSink</span><span class=p>.</span><span class=na>next</span><span class=p>(</span><span class=n>atomicInteger</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>synchronousSink</span><span class=p>.</span><span class=na>next</span><span class=p>(</span><span class=n>atomicInteger</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Flux generate
</span></span><span class=line><span class=cl>00:13:56.698 [main] ERROR reactor.core.publisher.Operators - Operator called default onErrorDropped
</span></span><span class=line><span class=cl>reactor.core.Exceptions$ErrorCallbackNotImplemented: java.lang.IllegalStateException: More than one call to onNext
</span></span><span class=line><span class=cl>Caused by: java.lang.IllegalStateException: More than one call to onNext
</span></span></code></pre></div><p>使用 <code>SynchronousSink</code> 发送超过一个元素是非法的。
因为我们不能发送多个元素，所以就算我们获取到 <code>SynchronousSink</code> 的引用也是没有意义的。</p><p>如果需要的话，<code>generate</code> 方法可以维护一个状态。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// initial state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>initialState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>65</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>BiFunction</span><span class=o>&lt;</span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>SynchronousSink</span><span class=o>&lt;</span><span class=n>Character</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>generator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=n>sink</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=na>intValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sink</span><span class=p>.</span><span class=na>next</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;Z&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sink</span><span class=p>.</span><span class=na>complete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Flux which accepts initialState and bifunction as arg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Character</span><span class=o>&gt;</span><span class=w> </span><span class=n>charFlux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>generate</span><span class=p>(</span><span class=n>initialState</span><span class=p>,</span><span class=w> </span><span class=n>generator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>charFlux</span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>50</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Consumed: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Consumed: A
</span></span><span class=line><span class=cl>Consumed: B
</span></span><span class=line><span class=cl>Consumed: C
</span></span><span class=line><span class=cl>Consumed: D
</span></span><span class=line><span class=cl>Consumed: E
</span></span><span class=line><span class=cl>Consumed: F
</span></span><span class=line><span class=cl>Consumed: G
</span></span><span class=line><span class=cl>Consumed: H
</span></span><span class=line><span class=cl>Consumed: I
</span></span><span class=line><span class=cl>Consumed: J
</span></span><span class=line><span class=cl>Consumed: K
</span></span><span class=line><span class=cl>Consumed: L
</span></span><span class=line><span class=cl>Consumed: M
</span></span><span class=line><span class=cl>Consumed: N
</span></span><span class=line><span class=cl>Consumed: O
</span></span><span class=line><span class=cl>Consumed: P
</span></span><span class=line><span class=cl>Consumed: Q
</span></span><span class=line><span class=cl>Consumed: R
</span></span><span class=line><span class=cl>Consumed: S
</span></span><span class=line><span class=cl>Consumed: T
</span></span><span class=line><span class=cl>Consumed: U
</span></span><span class=line><span class=cl>Consumed: V
</span></span><span class=line><span class=cl>Consumed: W
</span></span><span class=line><span class=cl>Consumed: X
</span></span><span class=line><span class=cl>Consumed: Y
</span></span><span class=line><span class=cl>Consumed: Z
</span></span></code></pre></div><br><div class="notice notice-info"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512" fill="hsl(30, 80%, 70%)"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p><strong>Flux Create</strong></p><ul><li>入参为 <code>Consumer&lt;FluxSink&lt;T>></code></li><li><code>Consumer</code> 只能被调用一次</li><li><code>Consumer</code> 马上发送 0 到 N 个元素</li><li>发布者不清楚下游的状态，所以我们需要提供一个 <code>OverflowStrategy</code> 作为额外的参数</li><li>我们可以拿到 <code>FluxSink</code> 的引用持续地发送元素，必要的话多线程也可以</li></ul></div><div class="notice notice-info"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512" fill="hsl(30, 80%, 70%)"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p><strong>Flux Generate</strong></p><ul><li>入参为 <code>Consumer&lt;SynchronousSink&lt;T>></code></li><li><code>Consumer</code> 可以基于下游的请求一遍一遍被调用</li><li><code>Consumer</code> 只能发送一个元素</li><li>发布者基于下游的请求生成元素</li><li>我们能拿到 <code>SynchronousSink</code> 的引用，但没啥用，因为我们只能发送一个元素</li></ul></div><h2 id=背压机制>背压机制</h2><h3 id=什么是背压>什么是背压</h3><p>在响应式数据流中，背压定义了如何调节数据流元素的传输。换句话说，控制消费者能接收到的数据量。
我们用一个例子来说明：</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure1.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure1.webp alt=backpressure1></a></div></p><ul><li>这个系统包含发布者，消费者，GUI</li><li>发布者每秒发送 10000 个数据给消费者</li><li>消费者处理数据并把结果发送给 GUI</li><li>GUI 对用户展示结果</li><li>消费者每秒只能处理 7500 个数据</li></ul><p>在这个速率下，消费者没有控制数据发送（背压），因此，这个系统会崩溃，用户也不会看到结果。</p><h3 id=背压预防系统故障>背压预防系统故障</h3><p>这里我们可以用一些背压策略来预防系统故障，来管理额外接收到的数据：</p><ul><li>首先我们会想到 <font color=orange>控制数据流的发送 </font>，发布者需要减缓发布数据的速度。这样，消费者就不会过载，不过，这并不总是可行的，我们得找到其他的选项。</li><li><font color=orange>缓存额外的数据元素 </font>。用这种方式，消费者缓存剩下的数据元素直到它能够处理为止。主要的缺点是可能会导致内存崩溃。</li><li><font color=orange>丢弃额外的元素 </font>。虽然这个解决办法也不是很理想，不过这样至少系统不会崩溃。</li></ul><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure2.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure2.webp alt=backpressure2></a></div></p><h3 id=背压控制>背压控制</h3><p>我们应该专注于让发布者控制数据的发送。有以下策略：</p><ul><li><font color=orange>当订阅者请求时才发送新的数据 </font>。这是一个拉取的策略。</li><li><font color=orange>限制客户端能够接收到元素的数量 </font>。作为限制的推送策略，发布者每次只能向客户端发送不超过指定数量的元素。</li><li><font color=orange>当消费者不能处理更多的数据时取消数据流 </font>。这种情况下，接收者能在任何给定的时间终止数据传输并在稍后重新订阅流。</li></ul><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure3.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure3.webp alt=backpressure3></a></div></p><h3 id=背压机制的实现>背压机制的实现</h3><h4 id=request>Request</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>testRequest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>intRange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//gets only 10 elements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>intRange</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>::</span><span class=n>println</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Throwable</span><span class=p>::</span><span class=n>printStackTrace</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;==== Completed ====&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscription</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>10</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>4
</span></span><span class=line><span class=cl>5
</span></span><span class=line><span class=cl>6
</span></span><span class=line><span class=cl>7
</span></span><span class=line><span class=cl>8
</span></span><span class=line><span class=cl>9
</span></span><span class=line><span class=cl>10
</span></span></code></pre></div><p>用这种方式，消费者永远不会被发布者的数据压垮。换句话说，消费者在控制它能处理的数据元素。</p><h4 id=limit>Limit</h4><p><strong>先看下不做限制默认的情况</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>log</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>100</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>::</span><span class=n>println</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>00:05:21.718 [main] INFO reactor.Flux.Range.1 - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)
</span></span><span class=line><span class=cl>00:05:21.720 [main] INFO reactor.Flux.Range.1 - | request(32)
</span></span><span class=line><span class=cl>00:05:21.720 [main] INFO reactor.Flux.Range.1 - | onNext(1)
</span></span><span class=line><span class=cl>00:05:21.755 [main] INFO reactor.Flux.Range.1 - | onNext(2)
</span></span><span class=line><span class=cl>00:05:21.756 [main] INFO reactor.Flux.Range.1 - | onNext(3)
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>00:05:21.756 [main] INFO reactor.Flux.Range.1 - | onNext(32)
</span></span><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>23
</span></span><span class=line><span class=cl>00:05:23.198 [parallel-3] INFO reactor.Flux.Range.1 - | request(24)
</span></span><span class=line><span class=cl>00:05:23.199 [parallel-3] INFO reactor.Flux.Range.1 - | onNext(33)
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>00:05:23.204 [parallel-3] INFO reactor.Flux.Range.1 - | onNext(56)
</span></span><span class=line><span class=cl>24
</span></span><span class=line><span class=cl>25
</span></span><span class=line><span class=cl>26
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>47
</span></span><span class=line><span class=cl>00:05:24.715 [parallel-7] INFO reactor.Flux.Range.1 - | request(24)
</span></span><span class=line><span class=cl>00:05:24.715 [parallel-7] INFO reactor.Flux.Range.1 - | onNext(57)
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>00:05:24.721 [parallel-7] INFO reactor.Flux.Range.1 - | onNext(79)
</span></span><span class=line><span class=cl>00:05:24.721 [parallel-7] INFO reactor.Flux.Range.1 - | onNext(80)
</span></span><span class=line><span class=cl>48
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>71
</span></span><span class=line><span class=cl>00:05:26.232 [parallel-11] INFO reactor.Flux.Range.1 - | request(24)
</span></span><span class=line><span class=cl>00:05:26.232 [parallel-11] INFO reactor.Flux.Range.1 - | onNext(81)
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>00:05:26.233 [parallel-11] INFO reactor.Flux.Range.1 - | onNext(98)
</span></span><span class=line><span class=cl>00:05:26.233 [parallel-11] INFO reactor.Flux.Range.1 - | onNext(99)
</span></span><span class=line><span class=cl>00:05:26.233 [parallel-11] INFO reactor.Flux.Range.1 - | onNext(100)
</span></span><span class=line><span class=cl>00:05:26.235 [parallel-11] INFO reactor.Flux.Range.1 - | onComplete()
</span></span><span class=line><span class=cl>72
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>95
</span></span><span class=line><span class=cl>00:05:27.751 [parallel-15] INFO reactor.Flux.Range.1 - | request(24)
</span></span><span class=line><span class=cl>96
</span></span><span class=line><span class=cl>97
</span></span><span class=line><span class=cl>98
</span></span><span class=line><span class=cl>99
</span></span><span class=line><span class=cl>100
</span></span></code></pre></div><ul><li>默认情况下，上游会收到一个获取 32 个元素的请求，32 个元素生产并发布给下游</li><li>一旦下游的 24 个元素被耗尽（日志可能显示 23，但它应该是 24。因为第 24 个元素被 <code>delayElement</code> 操作符延迟），上游收到另一个获取 24 个元素的请求</li><li>它会一直重复直到上游发送完成或者错误信号</li></ul><p><strong>限制每次只能请求 10 个元素</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>log</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>limitRate</span><span class=p>(</span><span class=n>10</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>delayElements</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>100</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>::</span><span class=n>println</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure4.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure4.webp alt=backpressure4></a></div></p><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>00:17:08.045 [main] INFO reactor.Flux.Range.1 - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)
</span></span><span class=line><span class=cl>00:17:08.048 [main] INFO reactor.Flux.Range.1 - | request(10)
</span></span><span class=line><span class=cl>00:17:08.048 [main] INFO reactor.Flux.Range.1 - | onNext(1)
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>00:17:08.085 [main] INFO reactor.Flux.Range.1 - | onNext(10)
</span></span><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>4
</span></span><span class=line><span class=cl>5
</span></span><span class=line><span class=cl>6
</span></span><span class=line><span class=cl>7
</span></span><span class=line><span class=cl>00:17:08.514 [parallel-7] INFO reactor.Flux.Range.1 - | request(8)
</span></span><span class=line><span class=cl>00:17:08.514 [parallel-7] INFO reactor.Flux.Range.1 - | onNext(11)
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>00:17:13.623 [parallel-7] INFO reactor.Flux.Range.1 - | onNext(98)
</span></span><span class=line><span class=cl>88
</span></span><span class=line><span class=cl>89
</span></span><span class=line><span class=cl>90
</span></span><span class=line><span class=cl>91
</span></span><span class=line><span class=cl>92
</span></span><span class=line><span class=cl>93
</span></span><span class=line><span class=cl>94
</span></span><span class=line><span class=cl>95
</span></span><span class=line><span class=cl>00:17:14.126 [parallel-15] INFO reactor.Flux.Range.1 - | request(8)
</span></span><span class=line><span class=cl>00:17:14.127 [parallel-15] INFO reactor.Flux.Range.1 - | onNext(99)
</span></span><span class=line><span class=cl>00:17:14.127 [parallel-15] INFO reactor.Flux.Range.1 - | onNext(100)
</span></span><span class=line><span class=cl>00:17:14.130 [parallel-15] INFO reactor.Flux.Range.1 - | onComplete()
</span></span><span class=line><span class=cl>96
</span></span><span class=line><span class=cl>97
</span></span><span class=line><span class=cl>98
</span></span><span class=line><span class=cl>99
</span></span><span class=line><span class=cl>100
</span></span></code></pre></div><p>一旦有 75% 的数据被发出，它就会自动请求并重新装满该数额。这就是为什么我们首先看到请求 10 个元素，之后每次都会看到请求 8 个元素。</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure5.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/backpressure5.webp alt=backpressure5></a></div></p><h4 id=cancel>Cancel</h4><p>更好地控制数据流的方式是在需要的时候取消订阅。你可以用 <code>BaseSubscriber::hookOnNext</code> 订阅生产者。
参考下面的例子，生产者只有在订阅者发送 <code>request(1)</code> 时才会发送下一个元素。实际上，这个生产者可以是一个数据库，而订阅者可以是一个 I/O 设备。为了配置运算的速度，I/O 设备可以请求一批数据并处理，然后再请求下一批数据，以此类推。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancelCallback</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>intRange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>range</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>).</span><span class=na>log</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>intRange</span><span class=p>.</span><span class=na>doOnCancel</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;===== Cancel method invoked =======&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>doOnComplete</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;==== Completed ====&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>BaseSubscriber</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>hookOnNext</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//request next element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>5</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>00:11:07.921 [main] INFO reactor.Flux.Range.1 - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)
</span></span><span class=line><span class=cl>00:11:07.922 [main] INFO reactor.Flux.Range.1 - | request(unbounded)
</span></span><span class=line><span class=cl>00:11:07.923 [main] INFO reactor.Flux.Range.1 - | onNext(1)
</span></span><span class=line><span class=cl>00:11:08.431 [main] INFO reactor.Flux.Range.1 - | request(1)
</span></span><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>00:11:08.431 [main] INFO reactor.Flux.Range.1 - | onNext(2)
</span></span><span class=line><span class=cl>00:11:08.935 [main] INFO reactor.Flux.Range.1 - | request(1)
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>00:11:08.936 [main] INFO reactor.Flux.Range.1 - | onNext(3)
</span></span><span class=line><span class=cl>00:11:09.450 [main] INFO reactor.Flux.Range.1 - | request(1)
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>00:11:09.450 [main] INFO reactor.Flux.Range.1 - | onNext(4)
</span></span><span class=line><span class=cl>00:11:09.954 [main] INFO reactor.Flux.Range.1 - | request(1)
</span></span><span class=line><span class=cl>4
</span></span><span class=line><span class=cl>00:11:09.954 [main] INFO reactor.Flux.Range.1 - | onNext(5)
</span></span><span class=line><span class=cl>00:11:10.460 [main] INFO reactor.Flux.Range.1 - | request(1)
</span></span><span class=line><span class=cl>5
</span></span><span class=line><span class=cl>===== Cancel method invoked =======
</span></span><span class=line><span class=cl>00:11:10.463 [main] INFO reactor.Flux.Range.1 - | cancel()
</span></span><span class=line><span class=cl>00:11:10.484 [main] INFO reactor.Flux.Range.1 - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | request(unbounded)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | onNext(1)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | onNext(2)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | onNext(3)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | onNext(4)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | onNext(5)
</span></span><span class=line><span class=cl>00:11:10.486 [main] INFO reactor.Flux.Range.1 - | cancel()
</span></span></code></pre></div><h2 id=深入理解响应式流>深入理解响应式流</h2><h3 id=响应式流规范>响应式流规范</h3><p>2013 年末的时候，Netflix、Pivotal、Typesafe 等公司的工程师们共同发起了关于制定 <strong>响应流规范（Reactive Stream Specification）</strong> 的倡议和讨论，并在 Github 上创建了 <a class=link href=https://github.com/reactive-streams/reactive-streams-jvm target=_blank rel=noopener>reactive-streams-jvm
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/>
</span></a>项目。项目 README 就是规范正文。</p><p>了解这一规范对我们理解和使用开发库也是很有帮助的，因为规范的内容都是对响应式编程思想精髓的呈现。其中包括定义的响应式流的特点：</p><ol><li>具有处理无限数量元素的能力</li><li>按序处理</li><li>异步地传递元素</li><li>必须实现非阻塞的背压</li></ol><h3 id=响应式流接口>响应式流接口</h3><p>响应式流规范定义了四个接口：</p><ol><li><code>Publisher</code> 是能够发出元素的发布者。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Publisher</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol start=2><li><code>Subscriber</code> 是接收元素并响应的订阅者</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Subscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onComplete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>当执行 <code>subscribe</code> 方法时，发布者会回调订阅者的 <code>onSubscribe</code> 方法，这个方法中，通常订阅者会借助传入的 <code>Subscription</code> 向发布者请求 n 个数据。然后发布者通过不断调用订阅者的 <code>onNext</code> 方法向订阅者发出最多 n 个数据。如果数据全部发送完，则会调用 <code>onComplete</code> 信号告知订阅者流已经发完；如果有错误发生，则通过 <code>onError</code> 发出错误信号并终止数据流。</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle1.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle1.webp alt=principle1></a></div></p><ol><li><code>Subscription</code> 是 <code>Publisher</code> 和 <code>Subscriber</code> 的 &ldquo;中间人&rdquo;。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Subscription</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>n</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>当发布者调用 <code>subscribe</code> 方法注册订阅者时，会通过订阅者的 <code>onSubscribe</code> 传入 <code>Subscription</code> 对象，之后订阅者就可以使用这个 <code>Subscription</code> 对象的 <code>request</code> 方法向发布者请求元素。背压机制也正是基于此来实现的，因此第 4 个特点也实现了。</p><h3 id=订阅之后发生了什么>订阅之后发生了什么</h3><p>在 Reactor 中，我们最先接触的生成 <code>Publisher</code> 的方法就是 <code>Flux.just()</code>，下面我们来手写代码模拟一下 Reactor 的实现方式，帮助理解。</p><p>首先，确保项目引入了响应流规范的四个接口定义。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>org.reactivestreams<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>reactive-streams<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>1.0.4<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>先创建一个最最基础的类 <code>Flux</code>，它是一个 <code>Publisher</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.opoa.reactive.core</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.reactivestreams.Publisher</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.reactivestreams.Subscriber</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Publisher</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在 Reactor 中，<code>Flux</code> 既是一个发布者，又充当工具类的角色，当我们使用 <code>Flux.just()</code>、 <code>Flux.range()</code> 等工厂方法生成 <code>Flux</code> 时，会 new 一个新的 <code>Flux</code>，比如 <code>Flux.just()</code> 会返回一个 <code>FluxArray</code> 对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>just</span><span class=p>(</span><span class=n>T</span><span class=p>...</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FluxArray</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>返回的 <code>FluxArray</code> 对象是 <code>Flux.just</code> 生成的 <code>Publisher</code>，它继承自 <code>Flux</code>，并实现了 <code>subscribe</code> 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FluxArray</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=n>array</span><span class=p>;</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>FluxArray</span><span class=p>(</span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>actual</span><span class=p>.</span><span class=na>onSubscribe</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ArraySubscription</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>actual</span><span class=p>,</span><span class=w> </span><span class=n>array</span><span class=p>));</span><span class=w> </span><span class=c1>// 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li><code>FluxArray</code> 内部使用一个数组来保存数据</li><li><code>subscribe</code> 方法通常会回调 <code>Subscriber</code> 的 <code>onSubscribe</code> 方法，该方法需要传入一个 <code>Subscription</code> 对象，从而订阅者之后可以通过回调传回的 <code>Subscription</code> 的 <code>request</code> 方法跟 <code>FluxArray</code> 请求数据。</li></ol><p>继续编写 <code>ArraySubscription</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FluxArray</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>ArraySubscription</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subscription</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=n>array</span><span class=p>;</span><span class=w> </span><span class=c1>// 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>canceled</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>ArraySubscription</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>[]</span><span class=w> </span><span class=n>array</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>actual</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>actual</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>array</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>canceled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>array</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>actual</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>array</span><span class=o>[</span><span class=n>index</span><span class=o>++]</span><span class=p>);</span><span class=w> </span><span class=c1>// 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>actual</span><span class=p>.</span><span class=na>onComplete</span><span class=p>();</span><span class=w> </span><span class=c1>// 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>canceled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li><code>ArraySubscription</code> 是一个静态内部类。我们可以把它当成普通的类，只不过恰好定义在其他类的内部</li><li>Subscription 中也保存有一份数据</li><li>当有可以发出的元素时，回调订阅者的 <code>onNext</code> 方法传递元素</li><li>当所有的元素都发送完后，回调订阅者的 <code>onComplete</code> 方法</li><li>订阅者可以使用 <code>Subscription</code> 取消订阅</li></ol><p>至此，发布者就开发完了。我们来测试一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>fluxArrayTest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Flux</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=p>).</span><span class=na>subscribe</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Subscriber</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onSubscribe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w> </span><span class=c1>// 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>integer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onNext: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>integer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onComplete</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onComplete&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li><code>Subscriber</code> 通过匿名内部类定义，需要实现接口的四个方法</li><li>订阅时请求 5 个元素</li></ol><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>onSubscribe
</span></span><span class=line><span class=cl>onNext: 1
</span></span><span class=line><span class=cl>onNext: 2
</span></span><span class=line><span class=cl>onNext: 3
</span></span><span class=line><span class=cl>onNext: 4
</span></span><span class=line><span class=cl>onComplete
</span></span></code></pre></div><p>请求 3 个元素的时候，输出如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>onSubscribe
</span></span><span class=line><span class=cl>onNext: 1
</span></span><span class=line><span class=cl>onNext: 2
</span></span><span class=line><span class=cl>onNext: 3
</span></span></code></pre></div><p>没有完成事件，至此，一个简单的 <code>Flux.just</code> 就完成了，通过这个例子我们能初步总结一下：</p><ul><li>工厂方法返回的是 <code>Flux</code> 子类的实例，如 <code>FluxArray</code></li><li><code>FluxArray</code> 的 <code>subscribe</code> 方法会返回给订阅者一个 <code>Subscription</code> 实现类的对象，这个 <code>ArraySubscription</code> 是 <code>FluxArray</code> 的静态内部类，它定义了 &ldquo;如何发布元素&rdquo; 的逻辑</li><li>订阅者可以通过这个 <code>ArraySubscription</code> 对象向发布者请求 n 个数据，发布者也可以借助这个 <code>ArraySubscription</code> 对象向订阅者传递数据元素（<code>onNext</code>/<code>onError</code>/<code>onComplete</code>）。</li></ul><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle2.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle2.webp alt=principle2></a></div></p><p>上图的这个过程基本适用于大多数的用于生成 <code>Flux</code>/<code>Mono</code> 的静态工厂方法，如 <code>Flux.just</code>、<code>Flux.range</code> 等等。</p><p>首先，使用类似 <code>Flux.just</code> 的方法创建发布者后，会创建一个具体的发布者（<code>Publisher</code>），如 <code>FluxArray</code>。</p><ol><li>当使用 <code>.subscribe</code> 订阅这个发布者时，首先会 new 一个具有相应逻辑的 <code>Subscription</code>（如 <code>ArraySubscription</code>，这个 <code>Subscription</code> 定义了如何处理下游的 <code>request</code>，以及如何发出元素）</li><li>然后发布者将这个 <code>Subscription</code> 通过订阅者的 <code>onSubscribe</code> 方法传给订阅者</li><li>在订阅者的.<code>onSubscribe</code> 方法中，需要通过 <code>Subscription</code> 发起第一次请求 <code>request</code></li><li><code>Subscription</code> 收到请求，就通过回调订阅者的 <code>onNext</code> 方法发出元素，有多少发多少，但不能超过请求的个数</li><li>订阅者在 <code>onNext</code> 中定义对元素的处理逻辑，处理完成之后，可以继续发起请求</li><li>发布者根据需求继续满足订阅者的请求</li><li>直至发布者的序列全部结束，通过订阅者的 <code>onComplete</code> 予以告知，当然如果序列在发送过程中有错误产生，则通过订阅者的 <code>onError</code> 告知错误信号，这两种情况都将终止序列。</li></ol><h3 id=操作符-流水线>操作符 &ldquo;流水线&rdquo;</h3><p>响应式开发库的一个很赞的特性就是可以像组装流水线一样将操作符串起来，用来声明复杂的处理逻辑。比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>::</span><span class=n>println</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>通过源码，我们可以了解这种 &ldquo;流水线&rdquo; 的实现机制。下面我们来模拟一下 Reactor 中 <code>Flux.map</code> 的实现方式。
<code>Flux.map</code> 用于实现转换，转换后的元素类型可能会发生变化，转换的逻辑由 <code>Function</code> 决定。方法本身返回的是一个转换后的 <code>Flux</code>，基于此，实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Publisher</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=nf>map</span><span class=p>(</span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FluxMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>mapper</span><span class=p>);</span><span class=w> </span><span class=c1>// 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li>泛型方法，通过泛型表示可能出现的类型变换（T —> V）</li><li><code>FluxMap</code> 就是新的 <code>Flux</code></li></ol><p>既然 <code>FluxMap</code> 是一个新的 <code>Flux</code>，那么与 <code>FluxArray</code> 类似，其内部定义有 <code>MapSubscription</code>，这是一个 <code>Subscription</code>，能够根据其订阅者的请求发出数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FluxMap</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>source</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>FluxMap</span><span class=p>(</span><span class=n>Flux</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>source</span><span class=p>,</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>source</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>mapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>MapSubscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subscription</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MapSubscriber</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>,</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>actual</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>actual</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>mapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//todo 收到请求 发出元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//todo 取消订阅</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li><code>map</code> 操作符并不产生数据，只是数据的搬运工。收到 <code>request</code> 后要发出的数据来自上游。</li></ol><p>所以 <code>MapSubscriber</code> 同时也应该是一个订阅者，它订阅上游的发布者，并将数据传递给下游的订阅者。</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle3.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle3.webp alt=principle3></a></div></p><p><strong>对下游作为发布者，传递上游的数据到下游，对上游是订阅者，传递下游的请求到上游。</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>MapSubscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Subscription</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li>所以我们既需要实现 <code>Subscription</code>，也需要实现 <code>Subscriber</code>。</li></ol><p>这样，总共有 6 个方法要实现：来自 <code>Subscriber</code> 接口的 <code>onSubscribe</code>、<code>onNext</code>、<code>onError</code>、<code>onComplete</code>，来自 <code>Subscription</code> 接口的 <code>request</code> 和 <code>cancel</code>。下面我们将实现这几个方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>source</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MapSubscriber</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>actual</span><span class=p>,</span><span class=w> </span><span class=n>mapper</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>MapSubscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Subscription</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>done</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Subscription</span><span class=w> </span><span class=n>subscriptionOfUpstream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MapSubscriber</span><span class=p>(</span><span class=n>Subscriber</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>actual</span><span class=p>,</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>mapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>actual</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>actual</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>mapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>subscriptionOfUpstream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>;</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>actual</span><span class=p>.</span><span class=na>onSubscribe</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w> </span><span class=c1>// 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>actual</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>mapper</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>t</span><span class=p>));</span><span class=w> </span><span class=c1>// 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>actual</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w> </span><span class=c1>// 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onComplete</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>actual</span><span class=p>.</span><span class=na>onComplete</span><span class=p>();</span><span class=w> </span><span class=c1>// 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>subscriptionOfUpstream</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>n</span><span class=p>);</span><span class=w> </span><span class=c1>// 6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>subscriptionOfUpstream</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w> </span><span class=c1>// 7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li>拿到来自上游的 <code>Subscription</code>。</li><li>回调下游的 <code>onSubscribe</code>，将自身作为 <code>Subscription</code> 传递过去</li><li>收到上游发出的数据后，将其用 <code>mapper</code> 进行转换，然后发给下游</li><li>将上游的错误信号原样发给下游</li><li>将上游的完成信号原样发给下游</li><li>将下游的请求传递给上游</li><li>将下游的取消操作传递给上游</li></ol><p>从这个对源码的模仿，可以体会到，当有多个操作符串成 &ldquo;链&rdquo; 的时候：</p><ul><li>向下：数据和信号（<code>onSubscribe</code>、<code>onNext</code>、<code>onError</code>、<code>onComplete</code>）是通过每一个操作符向下传递的，传递的过程中进行相应的操作处理。</li><li>向上：有一个自下而上的 &ldquo;订阅链&rdquo;，这个订阅链可以用来传递 <code>request</code>，因此背压（backpressure）可以实现从下游向上游传递。</li></ul><p>这一节最开头的那一段代码执行过程如下：</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle4.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle4.webp alt=principle4></a></div></p><h3 id=lambdasubscriber>LambdaSubscriber</h3><p><code>subscribe</code> 方法有几个不同的变种：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>subscribe</span><span class=p>(</span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>subscribe</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>errorConsumer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>subscribe</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>errorConsumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>completeConsumer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>subscribe</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>errorConsumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>completeConsumer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Consumer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Subscription</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriptionConsumer</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>用起来很方便，但响应式流规范中只定义了一个订阅方法 <code>subscribe(Subscriber subscriber)</code>。实际上，这几个方法最终都是调用的 <code>subscribe(LambdaSubscriber subscriber)</code>，并通过 <code>LambdaSubscriber</code> 实现了对不同个数参数的组装。如图所示：</p><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle5.webp><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/post/spring-webflux-principle5.webp alt=principle5></a></div></p><p>因此，<code>flux.subscribe(System.out::println, System.err::println)</code>;
是调用的 <code>flux.subscribe(new LambdaSubscriber(System.out::println, System.err::println, null, null));</code></p><h2 id=heading>🕳🕳🕳</h2><p>在使用 Reactor 的开发过程中，很容易因为对于操作符的不熟悉，使得程序没有按照预期执行。
而有些预期之外的行为，并不会对整体流程造成什么影响，但是在线上环境中，它们就像是一个个 &ldquo;不定时炸弹&rdquo;。所以，尽可能深入地熟悉你使用的操作符，是很有必要的。</p><h3 id=switchifempty-总是执行>SwitchIfEmpty 总是执行</h3><h4 id=示例>示例</h4><p>首先准备一个 <code>switchIfEmpty</code> 时执行的方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>emptyBackup</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;switchIfEmpty 执行&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>switchIfEmpty</span><span class=p>(</span><span class=n>emptyBackup</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>doOnNext</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onNext: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>switchIfEmpty 执行
</span></span><span class=line><span class=cl>onNext: 5
</span></span></code></pre></div><p>这段代码是没什么问题的，因为 <code>filter</code> 使得元素必须为 2 才能通过，而发布者只发出了一个值为 1 的元素值，执行到 <code>switchIfEmpty</code> 时数据流已经为空，便切换到 <code>emptyBackup</code>，后续的消费者执行时输出元素为 5。</p><p>我们稍微修改一下代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>switchIfEmpty</span><span class=p>(</span><span class=n>emptyBackup</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>doOnNext</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onNext: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>把 <code>filter</code> 中的为 2 时才通过改为 1。</p><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>switchIfEmpty 执行
</span></span><span class=line><span class=cl>onNext: 1
</span></span></code></pre></div><p>奇怪，<code>switchIfEmpty</code> 应该不满足才对，后续输出也为 1，而不是 <code>emptyBackup</code> 里面的 5。但它确实执行了。</p><p>我们再修改一下代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>switchIfEmpty</span><span class=p>(</span><span class=n>emptyBackup</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>doOnNext</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onNext: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>switchIfEmpty 执行
</span></span></code></pre></div><p>这次，我们去掉了 <code>subscribe</code>，总所周知，<strong>数据流在订阅之前什么都不会发生</strong>。但 <code>switchIfEmpty</code> 仍然执行了！说明它是在装配时期就执行了。</p><h4 id=为什么>为什么</h4><p>也许这并不是关于 Reactor 的问题，而是 Java 语言本身以及它如何解析参数的问题。我们试着把上面的代码用命令式编程的方式拆开：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>just</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>just</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>emptyBackup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>emptyBackup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>switchIfEmpty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filter</span><span class=p>.</span><span class=na>switchIfEmpty</span><span class=p>(</span><span class=n>emptyBackup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>doOnNext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>switchIfEmpty</span><span class=p>.</span><span class=na>doOnNext</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onNext: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>可以看到，在我们装配 <code>Mono</code> 类型的数据时，<code>emptyBackup</code> 已经被触发了。</p><h4 id=解决办法>解决办法</h4><p>在之前介绍操作符的时候有提到过，我们可以使用 <code>Mono.defer</code>，让它被请求时才会触发。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>switchIfEmpty</span><span class=p>(</span><span class=n>Mono</span><span class=p>.</span><span class=na>defer</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>emptyBackup</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>doOnNext</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;onNext: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>subscribe</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>onNext: 1
</span></span></code></pre></div><h2 id=参考资料>参考资料</h2><p><a class=link href=https://zhuanlan.zhihu.com/p/115912936 target=_blank rel=noopener>100% 弄明白 5 种 IO 模型
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://blog.51cto.com/liukang/2090163 target=_blank rel=noopener>响应式 Spring 的道法术器（Spring WebFlux 快速上手 + 全面介绍）
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://htmlpreview.github.io/?https://github.com/get-set/reactor-core/blob/master-zh/src/docs/index.html#faq.wrap-blocking target=_blank rel=noopener>Reactor 3 参考文档
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#zip-reactor.core.publisher.Mono-reactor.core.publisher.Mono- target=_blank rel=noopener>Mono(reactor-core 3.4.24)
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://stackoverflow.com/questions/49115135/map-vs-flatmap-in-reactor target=_blank rel=noopener>map vs flatMap in reactor
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://stackoverflow.com/questions/60077499/difference-between-mono-flux-fromcallable-and-mono-defer/60093080#60093080 target=_blank rel=noopener>Difference between Mono/Flux.fromCallable and Mono.defer
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://stackoverflow.com/questions/54373920/mono-switchifempty-is-always-called/54412779#54412779 target=_blank rel=noopener>Mono switchIfEmpty() is always called
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://stackoverflow.com/questions/67531829/how-to-handle-errors-in-reactive-spring-webflux target=_blank rel=noopener>How to handle errors in Reactive Spring webflux
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://www.vinsguru.com/reactor-repeat-vs-reactor-retry/ target=_blank rel=noopener>Reactor Repeat vs Retry | Vinsguru
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://www.woolha.com/tutorials/project-reactor-using-repeat-and-repeatwhen-examples target=_blank rel=noopener>Project Reactor - Using repeat and repeatWhen Examples
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://www.vinsguru.com/reactor-hot-publisher-vs-cold-publisher/ target=_blank rel=noopener>Reactor Hot Publisher vs Cold Publisher | Vinsguru
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://www.baeldung.com/spring-webflux-backpressure target=_blank rel=noopener>Backpressure Mechanism in Spring WebFlux
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://jstobigdata.com/java/backpressure-in-project-reactor/ target=_blank rel=noopener>Backpressure in Project reactor - Reactive Programming | Jstobigdata
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a><br><a class=link href=https://www.vinsguru.com/reactor-limitrate-example/ target=_blank rel=noopener>Reactor LimitRate Example | Vinsguru
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/spring/>Spring</a>
<a href=/tags/java/>Java</a>
<a href=/tags/spring-webflux/>Spring Webflux</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/post/dive-into-spring-webflux-4/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/pond-tea-rem.webp loading=lazy data-key=dive-into-spring-webflux-4 data-hash=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/pond-tea-rem.webp></div><div class=article-details><h2 class=article-title>响应式编程 Spring Webflux 详解（四）</h2></div></a></article><article class=has-image><a href=/post/dive-into-spring-webflux-3/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/pink-girl.webp loading=lazy data-key=dive-into-spring-webflux-3 data-hash=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/pink-girl.webp></div><div class=article-details><h2 class=article-title>响应式编程 Spring Webflux 详解（三）</h2></div></a></article><article class=has-image><a href=/post/dive-into-spring-webflux-2/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/rem-face-portrait-close.webp loading=lazy data-key=dive-into-spring-webflux-2 data-hash=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/rem-face-portrait-close.webp></div><div class=article-details><h2 class=article-title>响应式编程 Spring Webflux 详解（二）</h2></div></a></article><article class=has-image><a href=/post/dive-into-spring-webflux-1/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/miku-miko-twintails-aqua-eyes-mouse.webp loading=lazy data-key=dive-into-spring-webflux-1 data-hash=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/miku-miko-twintails-aqua-eyes-mouse.webp></div><div class=article-details><h2 class=article-title>响应式编程 Spring Webflux 详解（一）</h2></div></a></article><article class=has-image><a href=/post/idea-plugin-issue-navigation/><div class=article-image><img src=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/looker-with-her-hair-up.webp loading=lazy data-key=idea-plugin-issue-navigation data-hash=https://cdn.jsdelivr.net/gh/oopooa/cdn/cover/looker-with-her-hair-up.webp></div><div class=article-details><h2 class=article-title>谁懂这款 Idea 插件的含金量啊</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=oopooa/oopooa.github.io data-repo-id=R_kgDOMGuQ6Q data-category=Announcements data-category-id=DIC_kwDOMGuQ6c4CgB01 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 蜀ICP备20005474号-1</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建
主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section><section class=total-count>发表了 33 篇文章・
总计 66.74 k 字</section><section class=busuanzi-count><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv></span> 次
</span>·
<span id=busuanzi_container_site_uv>总访客数 <span id=busuanzi_value_site_uv></span> 人</span></section><section class=running-time>本博客已稳定运行 🧡
<span id=runningdays class=running-days></span></section></footer><script>runningTime(),setInterval(()=>{runningTime()},1e3);function runningTime(){let t="2020-02-02 22:22:22";t=new Date(t.replace(/-/g,"/"));let n=new Date,e=n.getTime()-t.getTime(),s=Math.floor(e/(1e3*60*60*24)),o=Math.floor(e%(1e3*60*60*24)/(1e3*60*60)),i=Math.floor(e%(1e3*60*60)/(1e3*60)),a=Math.floor(e%(1e3*60*60*24)%(1e3*60*60)%(1e3*60)/1e3),r=`${s} 天 ${zeroize(o)} 小时 ${zeroize(i)} 分钟 ${zeroize(a)} 秒`;document.querySelector("#runningdays").innerHTML=r}function zeroize(e){return e<10?"0"+e:e}</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://cdn.jsdelivr.net/gh/oopooa/cdn/css/opoa-font.css",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>